version: 2

sources:
  - name: fivetran_log
    database: "{{var ('fivetran_log_database', target.database)}}"
    schema: "{{var ('fivetran_log_schema', 'fivetran_log')}}"

    loader: fivetran
    loaded_at_field: _fivetran_synced
      
    freshness: # what's appropriate here?
      warn_after: {count: 72, period: hour}
      error_after: {count: 96, period: hour}


    tables:
      - name: active_volume
        description: Table of monthly active rows (MAR) measured by table at various points in time.
        columns:
          - name: id
            description: System-generated unique ID of the active volume measurement.
            tests:
              - unique
              - not_null
          - name: connector_id
            description: Foreign key referencing the CONNECTOR whose table is being measured # eek this is not the case in our data...
          - name: destination_id
            description: Foreign key referencing the DESTINATION whose table is being measured
          - name: measured_at
            description: Timestamp of when the entry's MAR measurement was made.
          - name: monthly_active_rows
            description: The number of MAR measured on this date for this table
          - name: schema_name
            description: The name of the connector schema housing the measured table.
          - name: table_name
            description: The name of the table whose MAR is being measured.

      - name: connector
        description: Table of all connectors loading data into warehouses.
        columns: 
          - name: connector_id
            description: Unique ID of the connector - destination. Note that a connector loading data into 2 warehouses will have 2 distinct records.
            tests:
              - unique
              - not_null
          - name: connecting_user_id
            description: Foreign key referencing the USER who set up the connector
          - name: connector_name
            description: Individual name of the connector
          - name: connector_type
            description: The kind of connector (ie google sheets, webhooks)
          - name: destination_id
            description: Foreign key referencing the DESTINATION warehouse that the connector data is loaded into.
          - name: paused
            description: Boolean that is true if the connector's sync is currently paused
          - name: signed_up
            description: Timestamp of when the connection was set up

      - name: credits_used
        description: Table of the credits used by the customer per each month.
        tests:
          - dbt_utils.unique_combination_of_columns:
                combination_of_columns: 
                  - destination_id
                  - measured_month
        columns:
          - name: destination_id
            description: Foreign key referencing the DESTINATION warehouse that the credits were used on
          - name: measured_month
            description: The month (yyyy-mm) in which the credits were used
          - name: credits_consumed
            description: The number of credits used for the given month - destination


      - name: destination
        description: Table of the warehouse destinations that have data loaded into them.
        columns:
          - name: id
            description: Unique ID of the destination
            tests:
              - unique
              - not_null
          - name: account_id
            description: Foreign key referencing the fivetran ACCOUNT associated with the destination
          - name: created_at
            description: Timestamp of when the destination was set up
          - name: name
            description: Name of the destination warehouse
          - name: region
            description: Geographical region of the destination
      
      - name: log
        description: Table of logged events related to data syncs
        tests:
          - dbt_utils.unique_combination_of_columns:
                combination_of_columns: 
                  - id
                  - time_stamp
        columns:
          - name: id # TODO: this is actually = connector name or transformation_id
          - name: created_at
            description: Timestamp of when the event was logged
          - name: connector_id # todo - figure this out, actually = connector_name
          - name: event
            description: The umbrella category of the event -- either INFO, SEVERE, WARNING, or TRANSFORMATION
          - name: message_data # todo: unsure what to rename these...
            description: JSON of the event-specific data
          - name: message_event
            description: More specific category related to the nature of the event
          - name: transformation_id
            description: Foreign key referencing the TRANSFORMATION if the event is a transformation
      